<!DOCTYPE html>
<html>
  <head>
    <title>Experiment</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="/assets/javascripts/jatos.js"></script>
    <script src="jspsych/jspsych.js"></script>
    <script src="jspsych/plugins/plugin-html-keyboard-response.js"></script>
    <script src="jspsych/plugins/plugin-call-function.js"></script>
    <script src="jspsych/plugins/plugin-instructions.js"></script>
    <script src="jspsych/plugins/plugin-fullscreen.js"></script>
    <script src="jspsych/custom-plugins/jspsych-fixation.js"></script>
    <script src="jspsych/plugins/plugin-html-button-response.js"></script>
    <script src="jspsych/custom-plugins/jspsych-item-presentation.js"></script>
    <script src="jspsych/custom-plugins/jspsych-free-recall.js"></script>
    <link href="jspsych/css/jspsych.css" rel="stylesheet" type="text/css"></link>
    <link href="jspsych/css/lpl-recall-recog-probe.css" rel="stylesheet" type="text/css"></link>
    <script type="module" src="helpers.js"></script>
  </head>
  <body></body>
  <script type="module">
    
    import { transpose, unique_entries, getEntriesBySubjectIndex, loadH5Data, loadItemPool, configureSubject, getTrialPerformance, getTotalPerformance, calculateBonus, getTrialTargetSuccess } from "./helpers.js";

    const config = {
      "data_path": "data/cuefr.h5",
      "stimuli_path": "assets/cuefr_pool.txt",
      "category_path": "assets/cuefr_labels.txt",
    };

    var jsPsych = initJsPsych({
      on_finish: () => jatos.endStudy(jsPsych.data.get().json())
    })

    jatos.onLoad(async function() {

      let timeline = []

      var cursor_off = {
        type: jsPsychCallFunction,
        func: function() {
            document.body.style.cursor= "none";
        }
      }

      var cursor_on = {
        type: jsPsychCallFunction,
        func: function() {
            document.body.style.cursor= "auto";
        }
      }

      // define prompt for fullscreen mode
      const fullscreen = {
        type: jsPsychFullscreen,
        message: '<p ><u>Full Screen Mode:</u> To help ensure data quality, we ask that you complete the experiment with your browser in fullscreen mode. If your browser supports it, the experiment will switch to full screen mode when you press the button below. Once you are finished with the experiment, your browser should leave fullscreen mode automatically.</p><p>Press Continue when you are ready to proceed.</p>',
        fullscreen_mode: true
      }
      timeline.push(fullscreen)

      const consent = {
        type: jsPsychInstructions,
        pages: [
          '<p  >The following information is provided to inform you about the research project and your participation in it. Please read this form carefully before proceeding.</p><embed src="assets/Remote_ICD_BEH_PERF.pdf" style="width: 75%" height="750"></embed>'
        ],
        show_clickable_nav: true,
        key_forward: 'm',
        key_backward: 'z',
        button_label_previous: 'Previous (<strong>Z</strong>)',
        button_label_next: 'Next (<strong>M</strong>)'
      }
      timeline.push(consent)

      const instructions = {
        type: jsPsychInstructions,
        pages: [
          `<p >Welcome to the experiment!</p><p>In this experiment, you'll be asked to study and remember words.</p><p>Press Next when you are ready to proceed.</p>`,
          '<p >During the study period, you will see a series of study items presented one at a time.</p><p>Each study item will be presented with a category label, like this:</p><p></p><p class="stimulus-category" style="font-size: 24px;">MUSIC STYLE</p><p class="stimulus-word" style="font-size: 48px;">hip hop</p><p>Your goal is to remember the study item for a later memory test.</p>',
          '<p >After the entire list is presented, you will type as many study items as you can remember.</p><p>Sometimes you will get a prompt that asks for an item from a particular category, and sometimes you will get a prompt that asks for any item.</p><p>Here\'s what those prompts will look like:</p><p></p><p class="instruction-text" style="font-size: 24px; border: solid purple">Recall MUSIC STYLE</p><p style="font-size: 48px;">_</p><p></p><p class="instruction-text" style="font-size: 24px;">Recall ANY ITEM</p><p style="font-size: 48px;">_</p>',
          '<p>Performance Bonus</p><p>You\'ll get an extra 5 cents for every item you recall correctly, and an extra 25 cents every time you correctly remember an item with a category cue.</p><p>Category cues are wrapped in a purple border for emphasis:</p><p></p><p class="instruction-text" style="font-size: 24px; border: solid purple">Recall MUSIC STYLE</p><p></p><p>Pay attention to both items and their categories during the study phase so you can maximize your bonus!</p>',
          '<p >After you type a given item, you\'ll press ENTER to submit it.</p><p>Do your best with spelling, but don\'t worry too much about minor spelling errors.</p><p>If you do make major typos, you can press BACKSPACE to undo individual characters or ENTER to clear your text.</p><p>You will be given a full minute to remember the study items. Sometimes a study item will come to you after several seconds, so keep trying until the end of the minute.</p>',
          '<p >If you can\'t remember an item that fits a given category prompt, you can press ENTER to move on.</p>',
          '<p >You\'ll get a little break in between trials.</p><p>Take a few seconds, and when you\'re ready for the next trial, press Next.</p>',
        ],
        show_clickable_nav: true,
        key_forward: 'm',
        key_backward: 'z',
        button_label_previous: 'Previous (<strong>Z</strong>)',
        button_label_next: 'Next (<strong>M</strong>)'
      }
      timeline.push(instructions)
      timeline.push({
        type: jsPsychInstructions,
        pages:[
          '<p>END OF INSTRUCTIONS. PLEASE CHECK IN</p><p>Once you\'ve checked in with the experimenter, you\'re ready for a practice trial.</p>',
        ],
      })
      timeline.push(cursor_off)

      // load data from config.data_path
      console.log('data_path: ' + config.data_path)
      const data = await loadH5Data(config.data_path)

      // load stimulus pool from config.stimuli_path
      console.log('stimuli_path: ' + config.stimuli_path)
      const stimulus_pool = await loadItemPool(config.stimuli_path)

      // configure subject and get subject presentations
      const subjectId = configureSubject(data, jatos.batchSession)
      config.subjectId = subjectId
      const subject_presentations = getEntriesBySubjectIndex(data, "pres_itemids", subjectId)
      let trial_count = subject_presentations.length
      console.log('subjectId: ' + subjectId)
      
      // load category pool and cues and targets if available
      let category_pool;
      let category_cues;
      let category_targets;
      let category_target_strings;
      if ('category_path' in config) {
        console.log('category_path: ' + config.category_path)
        category_cues = getEntriesBySubjectIndex(data, "category_cues", subjectId)
        category_targets = getEntriesBySubjectIndex(data, "category_cue_itemids", subjectId)
        category_pool = await loadItemPool(config.category_path)
        category_target_strings = category_targets.map((target_array) => {
          return target_array.map((target) => {
            if (target === 0) {
              return '';
            } else {
              return stimulus_pool[target - 1];
            }
          });
        });
      }

      for (let i = 0; i < trial_count; i++) {

        // TODO: account for variable list length (coded as 0 in pres_itemids)
        let presentation_stimuli = []
        for (let j = 0; j < subject_presentations[i].length; j++)
          presentation_stimuli.push(stimulus_pool[subject_presentations[i][j] - 1]);
        console.log(i + 'th trial presentation_stimuli: ' + presentation_stimuli);

        let presentation_categories = []
        if ('category_path' in config) {
          for (let j = 0; j < subject_presentations[i].length; j++) {
            if (subject_presentations[i][j] === 0) {
              presentation_categories.push('');
            } else {
              presentation_categories.push(category_pool[subject_presentations[i][j] - 1]);
            }
          }
          console.log(i + 'th trial presentation_categories: ' + presentation_categories);
        }

        timeline.push(cursor_off)
        timeline.push({type: jsPsychFixation})
        timeline.push({
          type: jsPsychItemPresentation, 
          word_list: presentation_stimuli, 
          category_list: presentation_categories,
          word_time: 1,
          inter_word_time: 0,
        })
        
        // Add six recall events per trial
        for (let recall_index = 0; recall_index < 6; recall_index++) {
          let category_cue = '';
          if (recall_index % 2 === 0 && 'category_path' in config) {  
            // Recalls 1, 3, 5 use category cues
            category_cue = category_cues[i][recall_index / 2] !== -1 
                          ? category_pool[category_cues[i][recall_index / 2] - 1] 
                          : '';
          }

          timeline.push({
            type: jsPsychFreeRecall,
            initial_category_cue: category_cue,  // Category cue for recalls 1, 3, 5; blank for 2, 4, 6
            response_limit: 1,  // Limit to 1 recall per event
            data: {
              "category_target": category_targets[i][Math.floor(recall_index / 2)],  // Use the appropriate target for 1, 3, 5
              "category_target_string": category_target_strings[i][Math.floor(recall_index / 2)]  // Handle corresponding strings
            }
          });
        }

        let message;
        switch (i) {
          case 0:
            message = `<p >You've completed the practice trial! Please check in with the experimenter before proceeding to the next trial.</p>`;
            break;
          case trial_count - 1:
            message = `<p >You have completed the experiment. Thank you for your participation!</p>`;
            break;
          default:
            message = `<p >When you're ready for the next trial, press Next.</p>`;
        }

        const end_trial_fn = function() {
          const last_trial_data = jsPsych.data.getLastTimelineData()
          const recall_total = getTrialPerformance(last_trial_data)
          const trial_count = jsPsych.getCurrentTrial().data.trial_count
          const i = jsPsych.getCurrentTrial().data.trial_index
          let message = jsPsych.getCurrentTrial().data.message

          const cued_items_message = 'You successfully recalled {success_count} out of {num_cued_recall_events} items cued by category labels in this trial.';
          let category_target_success = [];
          let success_count = 0;  // Count how many successful recalls
          let num_cued_recall_events = 3;  // Assuming you have 3 cued recall events (1, 3, 5)
          
          if ('category_path' in config) {
            const is_control_trial = category_cues[i].every(cue => cue === 0);
            if (!is_control_trial) {
                for (let recall_index = 0; recall_index < num_cued_recall_events; recall_index++) {
                  const success = getTrialTargetSuccess(
                    last_trial_data, 
                    category_target_strings[i][recall_index],  // Target string for this recall
                    recall_index  // Which recall event we are checking
                  );
                  
                  category_target_success.push(success);
                  
                  if (success) {
                    success_count += 1;
                  }
                }

                // Dynamically create the feedback message using success_count
                message = `<p>${cued_items_message
                  .replace('{success_count}', success_count)
                  .replace('{num_cued_recall_events}', num_cued_recall_events)}</p>` + message;
                console.log(message)
            }
          }
          console.log(message)
          const full_message = `<p>You've completed trial ${i+1} of ${trial_count}, nice work!</p><p>Total List Items Recalled: ${recall_total}${message}`
          return [full_message];
        }

        timeline.push(cursor_on)
        if (i == 0) {
          timeline.push({
            type: jsPsychInstructions,
            pages: end_trial_fn,
            data: {"trial_index": i, "trial_count": trial_count, "message": message}
          })
        } else {
          timeline.push({
            type: jsPsychInstructions,
            pages: end_trial_fn,
            show_clickable_nav: true,
            key_forward: 'm',
            key_backward: 'z',
            button_label_previous: 'Previous (<strong>Z</strong>)',
            button_label_next: 'Next (<strong>M</strong>)',
            data: {"trial_index": i, "trial_count": trial_count, "message": message}
          })
        }
      }

      timeline.push({
        type: jsPsychInstructions,
        pages: function() {
          
          console.log('category_target_strings: ' + category_target_strings)
          const bonus = calculateBonus(jsPsych.data.getLastTimelineData(), category_target_strings)
          const message = `You've completed the experiment! items. Your performance bonus is $${bonus}. Your subject ID is ${subjectId}. Please check in with the experimenter to receive your bonus.`
          return [message];
        },
        data: function() {
          const cued_recall_indices = [0, 2, 4];  // Example: cued recalls at 1st, 3rd, and 5th positions
        return {"bonus": calculateBonus(jsPsych.data.getLastTimelineData(), category_target_strings, cued_recall_indices)}
        },
      });

      jsPsych.data.addProperties(config);
      jsPsych.run(timeline)
    })
  </script>
</body>
</html>
